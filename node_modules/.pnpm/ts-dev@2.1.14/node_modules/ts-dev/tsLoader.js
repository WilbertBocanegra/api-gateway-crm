import url from 'url';
import path from 'path';
import typescript from 'typescript';
import { inspect } from 'util';
const escapedAsterixRe = /\\\*/g;
/**
 * @author https://github.com/sindresorhus/escape-string-regexp
  */
const escapeStringRegexp = (s) => s.replace(/[|\\{}()[\]^$+*?.]/g, '\\$&').replace(/-/g, '\\x2d');
const configFilePath = typescript.findConfigFile('.', typescript.sys.fileExists);
let paths = [];
let rootDirs = [];
let rootDirsRegs = [];
let outDir = '';
if (configFilePath) {
    const readConfigFileResult = typescript.parseJsonSourceFileConfigFileContent(typescript.readJsonConfigFile(configFilePath, typescript.sys.readFile), typescript.sys, './');
    if (readConfigFileResult.errors.length) {
        throw new Error(`Unable to read project config file [${configFilePath}]. ${inspect(readConfigFileResult.errors)}`);
    }
    const compilerOptions = readConfigFileResult.options;
    compilerOptions.configFilePath = configFilePath;
    const configFileDir = path.dirname(configFilePath);
    if (compilerOptions.rootDir && compilerOptions.outDir) {
        const rootDir = path.resolve(configFileDir, compilerOptions.rootDir);
        outDir = path.resolve(configFileDir, compilerOptions.outDir);
        const baseUrl = path.resolve(configFileDir, compilerOptions.baseUrl ?? './');
        if (!compilerOptions.paths) {
            compilerOptions.paths = {};
        }
        if (!compilerOptions.rootDirs) {
            compilerOptions.rootDirs = [];
        }
        paths = Object.entries(compilerOptions.paths).map(([k, v]) => ({
            re: new RegExp(`^${escapeStringRegexp(k).replace(escapedAsterixRe, '(.*)')}$`),
            paths: v.map(p => url.pathToFileURL(path.resolve(outDir, path.relative(rootDir, path.resolve(baseUrl, p)))).href),
        }));
        rootDirs = compilerOptions.rootDirs.map(p => url.pathToFileURL(path.resolve(outDir, path.relative(rootDir, p))).href);
        rootDirsRegs = rootDirs.map(rd => new RegExp(`^(${escapeStringRegexp(rd)})(.*)$`));
    }
}
const asterixRe = /\*/g;
const notBareRe = /^[./]/;
const isModuleNotFoundException = (e) => e.code === 'ERR_MODULE_NOT_FOUND' || e.code === 'MODULE_NOT_FOUND';
export async function resolve(specifier, context, defaultResolver) {
    if (notBareRe.test(specifier)) {
        try {
            return await defaultResolver(specifier, context);
        }
        catch (e) {
            if (!isModuleNotFoundException(e)) {
                throw e;
            }
            for (const rootDirRe of rootDirsRegs) {
                const res = rootDirRe.exec(context.parentURL);
                if (!res) {
                    continue;
                }
                const [, base, tail] = res;
                for (const rootDir of rootDirs) {
                    if (rootDir === base) {
                        continue;
                    }
                    try {
                        return await defaultResolver(specifier, { parentURL: `${rootDir}${tail}`, conditions: context.conditions });
                    }
                    catch (e2) {
                        if (isModuleNotFoundException(e2)) {
                            continue;
                        }
                        throw e2;
                    }
                }
            }
            throw e;
        }
    }
    else {
        for (const path of paths) {
            const res = path.re.exec(specifier);
            if (res) {
                for (const subPath of path.paths) {
                    const parts = res.slice(1);
                    const href = subPath.replace(asterixRe, () => parts.shift());
                    try {
                        return await defaultResolver(href, context);
                    }
                    catch (e) {
                        if (isModuleNotFoundException(e)) {
                            continue;
                        }
                        throw e;
                    }
                }
            }
        }
    }
    return await defaultResolver(specifier, context);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHNMb2FkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdHNMb2FkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxHQUFHLE1BQU0sS0FBSyxDQUFDO0FBQ3RCLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLFVBQVUsTUFBTSxZQUFZLENBQUM7QUFFcEMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQixNQUFNLGdCQUFnQixHQUFHLE9BQU8sQ0FBQztBQUVqQzs7SUFFSTtBQUNKLE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxDQUFRLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMscUJBQXFCLEVBQUUsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztBQUV6RyxNQUFNLGNBQWMsR0FBRyxVQUFVLENBQUMsY0FBYyxDQUFDLEdBQUcsRUFBRSxVQUFVLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBRWpGLElBQUksS0FBSyxHQUFzQyxFQUFFLENBQUM7QUFDbEQsSUFBSSxRQUFRLEdBQWEsRUFBRSxDQUFDO0FBQzVCLElBQUksWUFBWSxHQUFhLEVBQUUsQ0FBQztBQUNoQyxJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7QUFFaEIsSUFBSSxjQUFjLEVBQUU7SUFFbEIsTUFBTSxvQkFBb0IsR0FBRyxVQUFVLENBQUMsb0NBQW9DLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLGNBQWMsRUFBRSxVQUFVLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFFM0ssSUFBSSxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFO1FBQ3RDLE1BQU0sSUFBSSxLQUFLLENBQUMsdUNBQXVDLGNBQWMsTUFBTSxPQUFPLENBQUMsb0JBQW9CLENB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LEVBQUcsQ0FBQyxDQUFDO29CQUM5RCxJQUFJO3dCQUNGLE9BQU8sTUFBTSxlQUFlLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO3FCQUM3QztvQkFBQyxPQUFPLENBQUMsRUFBRTt3QkFDVixJQUFJLHlCQUF5QixDQUFDLENBQUMsQ0FBQyxFQUFFOzRCQUNoQyxTQUFTO3lCQUNWO3dCQUNELE1BQU0sQ0FBQyxDQUFDO3FCQUNUO2lCQUNGO2FBQ0Y7U0FDRjtLQUNGO0lBQ0QsT0FBTyxNQUFNLGVBQWUsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDbkQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB1cmwgZnJvbSAndXJsJztcclxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCB0eXBlc2NyaXB0IGZyb20gJ3R5cGVzY3JpcHQnO1xyXG5pbXBvcnQgdHlwZSB7IFJlc29sdmVDb250ZXh0LCBEZWZhdWx0UmVzb2x2ZXIgfSBmcm9tICcuL2VzbSc7XHJcbmltcG9ydCB7IGluc3BlY3QgfSBmcm9tICd1dGlsJztcclxuXHJcbmNvbnN0IGVzY2FwZWRBc3Rlcml4UmUgPSAvXFxcXFxcKi9nO1xyXG5cclxuLyoqXHJcbiAqIEBhdXRob3IgaHR0cHM6Ly9naXRodWIuY29tL3NpbmRyZXNvcmh1cy9lc2NhcGUtc3RyaW5nLXJlZ2V4cFxyXG4gICovXHJcbmNvbnN0IGVzY2FwZVN0cmluZ1JlZ2V4cCA9IChzOnN0cmluZykgPT4gcy5yZXBsYWNlKC9bfFxcXFx7fSgpW1xcXV4kKyo/Ll0vZywgJ1xcXFwkJicpLnJlcGxhY2UoLy0vZywgJ1xcXFx4MmQnKTtcclxuXHJcbmNvbnN0IGNvbmZpZ0ZpbGVQYXRoID0gdHlwZXNjcmlwdC5maW5kQ29uZmlnRmlsZSgnLicsIHR5cGVzY3JpcHQuc3lzLmZpbGVFeGlzdHMpO1xyXG5cclxubGV0IHBhdGhzOiB7IHJlOiBSZWdFeHA7IHBhdGhzOiBzdHJpbmdbXSB9W10gPSBbXTtcclxubGV0IHJvb3REaXJzOiBzdHJpbmdbXSA9IFtdO1xyXG5sZXQgcm9vdERpcnNSZWdzOiBSZWdFeHBbXSA9IFtdO1xyXG5sZXQgb3V0RGlyID0gJyc7XHJcblxyXG5pZiAoY29uZmlnRmlsZVBhdGgpIHtcclxuXHJcbiAgY29uc3QgcmVhZENvbmZpZ0ZpbGVSZXN1bHQgPSB0eXBlc2NyaXB0LnBhcnNlSnNvblNvdXJjZUZpbGVDb25maWdGaWxlQ29udGVudCh0eXBlc2NyaXB0LnJlYWRKc29uQ29uZmlnRmlsZShjb25maWdGaWxlUGF0aCwgdHlwZXNjcmlwdC5zeXMucmVhZEZpbGUpLCB0eXBlc2NyaXB0LnN5cywgJy4vJyk7XHJcblxyXG4gIGlmIChyZWFkQ29uZmlnRmlsZVJlc3VsdC5lcnJvcnMubGVuZ3RoKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byByZWFkIHByb2plY3QgY29uZmlnIGZpbGUgWyR7Y29uZmlnRmlsZVBhdGh9XS4gJHtpbnNwZWN0KHJlYWRDb25maWdGaWxlUmVzdWx0LmVycm9ycyl9YCk7XHJcbiAgfVxyXG5cclxuICBjb25zdCBjb21waWxlck9wdGlvbnMgPSByZWFkQ29uZmlnRmlsZVJlc3VsdC5vcHRpb25zO1xyXG4gIGNvbXBpbGVyT3B0aW9ucy5jb25maWdGaWxlUGF0aCA9IGNvbmZpZ0ZpbGVQYXRoO1xyXG5cclxuICBjb25zdCBjb25maWdGaWxlRGlyID0gcGF0aC5kaXJuYW1lKGNvbmZpZ0ZpbGVQYXRoKTtcclxuXHJcbiAgaWYgKGNvbXBpbGVyT3B0aW9ucy5yb290RGlyICYmIGNvbXBpbGVyT3B0aW9ucy5vdXREaXIpIHtcclxuXHJcbiAgICBjb25zdCByb290RGlyID0gcGF0aC5yZXNvbHZlKGNvbmZpZ0ZpbGVEaXIsIGNvbXBpbGVyT3B0aW9ucy5yb290RGlyKTtcclxuICAgIG91dERpciA9IHBhdGgucmVzb2x2ZShjb25maWdGaWxlRGlyLCBjb21waWxlck9wdGlvbnMub3V0RGlyKTtcclxuICAgIGNvbnN0IGJhc2VVcmwgPSBwYXRoLnJlc29sdmUoY29uZmlnRmlsZURpciwgY29tcGlsZXJPcHRpb25zLmJhc2VVcmwgPz8gJy4vJyk7XHJcblxyXG4gICAgaWYgKCFjb21waWxlck9wdGlvbnMucGF0aHMpIHtcclxuICAgICAgY29tcGlsZXJPcHRpb25zLnBhdGhzID0ge307XHJcbiAgICB9XHJcbiAgICBpZiAoIWNvbXBpbGVyT3B0aW9ucy5yb290RGlycykge1xyXG4gICAgICBjb21waWxlck9wdGlvbnMucm9vdERpcnMgPSBbXTtcclxuICAgIH1cclxuXHJcbiAgICBwYXRocyA9IE9iamVjdC5lbnRyaWVzPHN0cmluZ1tdPihjb21waWxlck9wdGlvbnMucGF0aHMpLm1hcCgoW2ssIHZdKSA9PiAoe1xyXG4gICAgICByZTogbmV3IFJlZ0V4cChgXiR7ZXNjYXBlU3RyaW5nUmVnZXhwKGspLnJlcGxhY2UoZXNjYXBlZEFzdGVyaXhSZSwgJyguKiknKX0kYCksXHJcbiAgICAgIHBhdGhzOiB2Lm1hcChwID0+IHVybC5wYXRoVG9GaWxlVVJMKFxyXG4gICAgICAgIHBhdGgucmVzb2x2ZShcclxuICAgICAgICAgIG91dERpcixcclxuICAgICAgICAgIHBhdGgucmVsYXRpdmUoXHJcbiAgICAgICAgICAgIHJvb3REaXIsXHJcbiAgICAgICAgICAgIHBhdGgucmVzb2x2ZShiYXNlVXJsLCBwKSxcclxuICAgICAgICAgICksXHJcbiAgICAgICAgKSxcclxuICAgICAgKS5ocmVmKSxcclxuICAgIH0pKTtcclxuXHJcbiAgICByb290RGlycyA9IGNvbXBpbGVyT3B0aW9ucy5yb290RGlycy5tYXAocCA9PlxyXG4gICAgICB1cmwucGF0aFRvRmlsZVVSTChwYXRoLnJlc29sdmUoXHJcbiAgICAgICAgb3V0RGlyLFxyXG4gICAgICAgIHBhdGgucmVsYXRpdmUocm9vdERpciwgcCksXHJcbiAgICAgICkpLmhyZWYpO1xyXG5cclxuICAgIHJvb3REaXJzUmVncyA9IHJvb3REaXJzLm1hcChyZCA9PiBuZXcgUmVnRXhwKGBeKCR7ZXNjYXBlU3RyaW5nUmVnZXhwKHJkKX0pKC4qKSRgKSk7XHJcblxyXG4gIH1cclxufVxyXG5cclxuY29uc3QgYXN0ZXJpeFJlID0gL1xcKi9nO1xyXG5jb25zdCBub3RCYXJlUmUgPSAvXlsuL10vO1xyXG5cclxuY29uc3QgaXNNb2R1bGVOb3RGb3VuZEV4Y2VwdGlvbiA9IChlOiB7IGNvZGU6IHN0cmluZyB9KSA9PiBlLmNvZGUgPT09ICdFUlJfTU9EVUxFX05PVF9GT1VORCcgfHwgZS5jb2RlID09PSAnTU9EVUxFX05PVF9GT1VORCc7XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZShzcGVjaWZpZXI6IHN0cmluZywgY29udGV4dDogUmVzb2x2ZUNvbnRleHQsIGRlZmF1bHRSZXNvbHZlcjogRGVmYXVsdFJlc29sdmVyKSB7XHJcblxyXG4gIGlmIChub3RCYXJlUmUudGVzdChzcGVjaWZpZXIpKSB7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgcmV0dXJuIGF3YWl0IGRlZmF1bHRSZXNvbHZlcihzcGVjaWZpZXIsIGNvbnRleHQpO1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICBpZiAoIWlzTW9kdWxlTm90Rm91bmRFeGNlcHRpb24oZSkpIHtcclxuICAgICAgICB0aHJvdyBlO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBmb3IgKGNvbnN0IHJvb3REaXJSZSBvZiByb290RGlyc1JlZ3MpIHtcclxuICAgICAgICBjb25zdCByZXMgPSByb290RGlyUmUuZXhlYyhjb250ZXh0LnBhcmVudFVSTCk7XHJcbiAgICAgICAgaWYgKCFyZXMpIHtcclxuICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBbLCBiYXNlLCB0YWlsXSA9IHJlcztcclxuICAgICAgICBmb3IgKGNvbnN0IHJvb3REaXIgb2Ygcm9vdERpcnMpIHtcclxuICAgICAgICAgIGlmIChyb290RGlyID09PSBiYXNlKSB7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGRlZmF1bHRSZXNvbHZlcihzcGVjaWZpZXIsIHsgcGFyZW50VVJMOiBgJHtyb290RGlyfSR7dGFpbH1gLCBjb25kaXRpb25zOiBjb250ZXh0LmNvbmRpdGlvbnMgfSk7XHJcbiAgICAgICAgICB9IGNhdGNoIChlMikge1xyXG4gICAgICAgICAgICBpZiAoaXNNb2R1bGVOb3RGb3VuZEV4Y2VwdGlvbihlMikpIHtcclxuICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aHJvdyBlMjtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgdGhyb3cgZTtcclxuICAgIH1cclxuXHJcbiAgfSBlbHNlIHtcclxuICAgIGZvciAoY29uc3QgcGF0aCBvZiBwYXRocykge1xyXG4gICAgICBjb25zdCByZXMgPSBwYXRoLnJlLmV4ZWMoc3BlY2lmaWVyKTtcclxuICAgICAgaWYgKHJlcykge1xyXG4gICAgICAgIGZvciAoY29uc3Qgc3ViUGF0aCBvZiBwYXRoLnBhdGhzKSB7XHJcbiAgICAgICAgICBjb25zdCBwYXJ0cyA9IHJlcy5zbGljZSgxKTtcclxuICAgICAgICAgIGNvbnN0IGhyZWYgPSBzdWJQYXRoLnJlcGxhY2UoYXN0ZXJpeFJlLCAoKSA9PiBwYXJ0cy5zaGlmdCgpISk7XHJcbiAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgZGVmYXVsdFJlc29sdmVyKGhyZWYsIGNvbnRleHQpO1xyXG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICBpZiAoaXNNb2R1bGVOb3RGb3VuZEV4Y2VwdGlvbihlKSkge1xyXG4gICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRocm93IGU7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBhd2FpdCBkZWZhdWx0UmVzb2x2ZXIoc3BlY2lmaWVyLCBjb250ZXh0KTtcclxufVxyXG4iXX0=